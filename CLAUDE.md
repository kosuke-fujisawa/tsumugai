# CLAUDE.md

この文書は `tsumugai` の開発および利用におけるガイドラインです。  
LLM（Claude / ChatGPT など）にプロンプトを与える際の **思考の前提・制約・生成方針** を統一することを目的とします。

---

## 🎯 tsumugai は何か

`tsumugai` は、

**Markdown で書かれたノベルゲーム用シナリオを解析し、  
実行・検証・ドライランを行える  
「シナリオチェッカー付き多機能パースエンジン」** です。

- ゲームエンジンではありません
- UI / 描画 / 音声再生は行いません
- シナリオを **上から順に解釈可能な AST** に変換し、
  - 実行（runtime）
  - ドライラン
  - 妥当性チェック
  を **同一構造** で行います

最優先の利用者は **シナリオライター** です。

---

## 🧠 設計思想（最重要）

### ライター・LLM ファースト
- シナリオは **人間が直感的に読める**
- 同時に **LLM が構造を正確に把握できる**
- 暗黙仕様・省略・文脈依存を避ける

### 宣言してから使う
- フラグ・変数・条件は **必ず宣言されてから使用**
- 未宣言の参照はエラーまたはワーニング対象

### 実行と検証を分離できる
- 実行可能 = 正しい、ではない
- `dry-run` / `check` によって
  - 到達不能ルート
  - 条件漏れ
  - 指定不足
  を検出できることを重視する

---

## 🏗 開発アーキテクチャ

### モジュール構成（確定）

- **`parser/`**
  - Markdown DSL → AST 変換
  - 構文エラー・宣言漏れ検出
  - 文法拡張はここに閉じる

- **`runtime/`**
  - AST を 1 ステップずつ確定的に実行
  - 実行・ドライラン・デバッグ実行は同一ロジック
  - ステートレス設計

- **`storage/`**
  - State の保存 / 復元
  - JSON 形式・バージョン管理対応

```rust
use tsumugai::{parser, runtime, storage};

let ast = parser::parse(markdown)?;
let state = runtime::step(state, &ast, event);
let bytes = storage::save(&state)?;
```

⸻

📝 シナリオ生成ガイドライン（LLM 向け）

基本方針
	•	シナリオは Markdown で記述する
	•	ブロック構造を重視する
	•	条件・分岐は「見た目で追える」ことを優先する

推奨される構造要素
	•	# scene: シーン境界
	•	:::flag / :::vars 宣言ブロック
	•	:::choices 選択肢定義
	•	:::route 選択結果の処理
	•	:::when 条件付き実行ブロック

※ 正確な文法・制約は SPEC.md を参照すること

⸻

🔍 条件・式について
	•	条件は 式として記述する
	•	サポートされる論理：
	•	&& || !
	•	== != < > <= >=
	•	eval / 任意コード実行は行わない
	•	条件の意味は 宣言またはコメントで説明されていることが望ましい
```md
:::when help_count > 0 && route == "ayumi"
```

⸻

⚠️ チェックとワーニング
	•	tsumugai は 親切に警告する
	•	以下はワーニングまたはエラー対象
	•	未宣言フラグ・変数の使用
	•	選択肢に対応する route が存在しない
	•	条件が常に真 / 常に偽になる可能性
	•	必須演出（背景など）の未指定

ワーニングは 人格を持ったメッセージとして出力されることがある。

⸻

🧪 テスト方針
	•	TDD / テストファースト
	•	ユニットテスト
	•	parser / runtime / storage
	•	統合テスト
	•	シナリオ全体の dry-run 結果
	•	回帰テスト
	•	セーブデータ互換性

⸻

❌ やらないこと（明確に）
	•	任意式評価（eval）
	•	ユーザー定義関数
	•	ループ・再帰
	•	型推論
	•	外部コード実行

これらは アプリケーション層の責務とする。

⸻

🧭 LLM への指示例
	•	「tsumugai 形式でシナリオを書いて」
	•	「このシナリオを dry-run 観点でチェックして」
	•	「到達不能なルートを指摘して」
	•	「フラグの宣言漏れがないか確認して」

説明文は不要。
シナリオ本文のみを出力すること。