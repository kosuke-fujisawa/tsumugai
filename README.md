# tsumugai

tsumugai（つむがい）は、Markdown形式で書かれたノベルゲームのシナリオを順次実行するためのRust製ライブラリです。

## tsumugaiの役割

tsumugaiは、ノベルゲームのシナリオを読み込み、次に「何が起こるか」を決定し、その結果を構造化されたデータとして提供します。具体的には、以下の要素を解析して返却します。

*   次に表示すべきテキスト
*   プレイヤーが選択できる選択肢
*   シナリオの分岐先
*   現在のゲームの状態（セーブ/ロードの対象となるデータ）

**重要な注意点**: tsumugai自体は、テキストの描画、音声の再生、ユーザーインターフェース（UI）の制御といった視覚的・聴覚的な処理は一切行いません。

### tsumugaiができること

*   Markdown形式のシナリオファイルを解析（パース）します。
*   シナリオを記述された順序通りに実行します。
*   選択肢、シナリオの分岐、指定箇所へのジャンプといったロジックを解釈・処理します。
*   現在のゲームの実行状態を管理・保持します。
*   ゲームのセーブ・ロードが可能な状態データを提供します。
*   次にプレイヤーに何を表示したり、どのような選択肢を提示すべきかをデータとして出力します。

### tsumugaiがやらないこと（重要）

tsumugaiは以下の処理を**一切行いません**。

*   テキストや画像の画面への描画
*   キャラクターの表示や操作

これは、以下のような明確な役割分担を前提としているためです。

```
[ Markdown シナリオファイル ]
          ↓
       tsumugai
          ↓
[ 次に起こること（構造化されたデータ） ]
          ↓
  「あなたの」アプリケーション
```

*   **tsumugai**: 物語の進行ロジックのみを決定します。
*   **あなたのアプリケーション**: tsumugaiから受け取ったデータに基づいて、どのように表示するか、どのような音を鳴らすか、UIをどのように動かすか自由に実装します。

## 最小の使用例（CUI）

tsumugaiを使って、コンソール上でノベルゲームを実行する最小限の例を示します。

```rust
use tsumugai::{Engine, UserEvent};

fn main() -> anyhow::Result<()> {
    let scenario = r#"
[SAY speaker=Alice]
こんにちは。

[CHOICE id=go label="進む" goto=next]

# scene: next
[SAY speaker=Alice]
おしまい。
"#;

    let mut engine = Engine::from_markdown(scenario)?;

    loop {
        let step = engine.step(None)?;

        for directive in step.directives {
            println!("{:?}", directive); // tsumugaiが出力したディレクティブをそのまま表示
        }

        match step.next {
            tsumugai::NextAction::WaitUser => {
                // ユーザーが何か入力するまで待つ
                let mut _buf = String::new();
                std::io::stdin().read_line(&mut _buf)?;
            }
            tsumugai::NextAction::WaitChoice => {
                // 選択肢が提示されたら、特定の選択肢を選ぶ
                engine.step(Some(UserEvent::Choose("go".into())))?;
            }
            tsumugai::NextAction::Halt => break, // シナリオ終了
        }
    }

    Ok(())
}
```

この例のポイントは以下の通りです。

*   すべての描画（出力）は`println!`で行っています。
*   `tsumugai`は、あくまで「何を（どのようなデータとして）出すか」だけを決定しており、具体的な表示方法はアプリケーション側に委ねられています。

## シナリオ形式

*   シナリオは標準的なMarkdownファイルとして記述します。
*   Markdownの見出しやコメント機能を活用できます。
*   人間にとっても、LLM（大規模言語モデル）にとっても読みやすい形式であることを重視しています。

詳細な記法については、`docs/`ディレクトリ内のドキュメントを参照してください。

## 設計方針（簡潔版）

*   **テストファースト**: 徹底したテスト駆動開発（TDD） (`cargo test`)。
*   **単一責任・関心の分離**: 各モジュールが持つべき責任を明確にし、相互の関心事を分離します。
*   **最小限の責務**: ライブラリの機能を必要最小限に絞り込み、シンプルさを追求します。
*   **「ライブラリは静かに振る舞う」**: アプリケーションの動作に過度な影響を与えず、縁の下の力持ちとして機能します。

tsumugaiは「これさえあればノベルゲームのロジックは動く」という、ノベルゲームエンジンの最小単位を目指しています。

## ライセンス

[MIT License](LICENSE)

## 補足

*   コマンドラインインターフェース（CLI）、Linter、グラフィカルユーザーインターフェース（GUI）、サンプルアプリケーションなどは、このライブラリとは別に提供されることを想定しています。
*   tsumugai自身は、純粋なRustライブラリとして自己完結しています。
