# tsumugai

tsumugai（つむがい）は、  
**Markdown で書かれたノベルゲーム用シナリオを解析し、  
その進行・分岐・条件が正しく書かれているかを確認できる  
Rust 製のシナリオパース＆検証ライブラリ**です。

描画・音声再生・UI 操作は行いません。  
代わりに、

> **「このシナリオは正しく進むか？」  
> 「指定漏れや破綻はないか？」**

を、コードとして扱える形で返します。

---

## これは何か？（一言で）

> **ノベルゲーム用シナリオのための  
> チェッカー付きシナリオパースエンジン**

- ゲームエンジンではありません
- UI や演出は含みません
- シナリオを **上から順に解釈できる構造**に変換します
- 実行もできます。特に 人間がシナリオの流れを確認・検証する用途を重視しています。

---

## tsumugai が解決したい問題

ノベルゲームのシナリオは、次のような問題を抱えがちです。

- 分岐が増えて **到達不能ルートが生まれる**
- 条件やフラグの **指定漏れに気づきにくい**
- 「動かしてみないと分からない」不安定さ
- LLM に書かせても **正しいか判断できない**

tsumugai は、  
**「シナリオを実行せずに問題を見つける」**ための道具です。

---

## tsumugai がやること

tsumugai は、Markdown 形式のシナリオを読み取り、  
以下を **同一の構造で一貫して処理**します。

### 1. シナリオを構造化する（パース）

- セリフ／ナレーション
- 選択肢
- 分岐・ジャンプ
- 条件付き実行（フラグ・変数・論理式）
- シナリオ進行状態

### 2. ドライラン・検証を行う

- 未宣言フラグ・変数の使用
- 選択肢と対応するルートの不整合
- 条件が常に真／常に偽になる可能性
- 到達不能なシナリオブロック
- 明らかな指定漏れ（背景未指定など）

👉 **「動かさなくても分かる」**ことを重視しています。

### 3. 必要であれば実行もできる

tsumugai は、  
描画や再生の代わりに **Directive（指示データ）** を返します。

- このテキストを表示してほしい
- ここで選択肢を出してほしい
- 次はこのルートに進む
- ユーザー入力を待つ

これを使って、  
CLI / GUI / ゲームエンジンと自由に接続できます。

---

## tsumugai がやらないこと（重要）

tsumugai は以下を **一切行いません**。

- テキスト・画像の描画
- 音声・BGM・SE の再生
- UI 操作・演出制御
- アニメーション

tsumugai の責務は、あくまで  
**「シナリオの意味・進行・整合性を決めること」**です。

```text
[ Markdown シナリオ ]
↓
tsumugai
↓
[ 構造化された進行 / ワーニング / Directive ]
↓
あなたのアプリケーション
```

---

## CLI の使い方

tsumugai は CLI コマンドでシナリオをプレイできます。

### play モード

シナリオを CUI プレイヤーで実際にプレイできます。

```bash
cargo run -- play scenario.md
```

play モードでは：
- セリフ・ナレーションを順に表示
- 選択肢が表示されたら番号（1-9）で選択
- Enter キーで次へ進む
- `b` で 1 ステップ戻る（Undo）
- `q` で終了

ゲーム実装前にシナリオを体験できます。

---

## 想定している利用者
	•	ノベルゲームを コードで管理したいエンジニア
	•	シナリオを Markdown / Git で扱いたい
	•	LLM（ChatGPT / Claude 等）で
	•	シナリオ生成
	•	ルート分岐の量産
	•	条件整理
を行いたい
	•	「このシナリオは正しいか？」を
自動でチェックしたい

完成済みノベルゲームエンジンの代替ではありません。

⸻

最小の使用例（ドライラン）
```rust
use tsumugai::{parser, runtime, types::State};

let markdown = std::fs::read_to_string("scenario.md")?;

// パース
let ast = parser::parse(&markdown)?;

// 初期状態
let mut state = State::new();

// ドライラン実行
while !state.is_finished() {
    let (new_state, output) = runtime::step(state, &ast, None);
    state = new_state;

    for warning in output.warnings {
        println!("⚠️ {}", warning);
    }
}
```
👉 実行せずに 問題点だけを確認できます。

⸻

シナリオ形式について
	•	標準的な Markdown
	•	見出し・コメントが使える
	•	人間にも LLM にも読みやすい
	•	独自構文は 意味が追える範囲に限定

👉 詳細な文法・制約は docs/SPEC.md を参照してください。

⸻

設計方針
	•	テストファースト（TDD）
	•	最小責務・単純な構造
	•	シナリオ解釈と検証に特化
	•	ライブラリは静かに振る舞う
	•	実装ではなく 意味を返す

⸻

tsumugai が目指すもの
	•	これさえあれば シナリオの正しさを確認できる
	•	実行にも検証にも使える
	•	LLM フレンドリーなノベルゲーム開発基盤

⸻

ライセンス

MIT License