# tsumugai Markdown Language Specification

## 0. このドキュメントについて

本ドキュメントは、Rust 製ライブラリ **tsumugai** が解釈・実行・検査する  
Markdown ベースのノベルゲームシナリオ言語の仕様を定義する。

- README は「tsumugai が何であるか」を説明する
- 本書（SPEC）は「何が正しい文法・意味であるか」を定義する

本書に記載された仕様が **tsumugai における正とする振る舞い**である。

---

## 1. 設計思想（Philosophy）

tsumugai Markdown は、以下の原則に基づいて設計される。

- シナリオは **上から順に読める**
- 分岐や条件は **明示的に構造として書ける**
- ライターが自然言語感覚で書ける
- LLM が安全に解析・生成・変換できる
- 指定漏れや構造ミスは **ドライランで検知可能**

tsumugai は演出エンジンではない。  
**「シナリオを解釈し、次に起こることを決める」ことのみを責務とする。**

---

## 2. 基本構造

### 2.1 ファイル

- シナリオは 1 つ以上の Markdown ファイルから構成される
- ファイルは上から下へ順に解釈される

### 2.2 Scene

```md
# scene: <scene_name>
```

	•	シナリオの論理的な区切り
	•	ジャンプ先・参照単位として使用される
	•	scene 名は一意である必要がある

⸻

## 3. コマンド（Command）

### 3.1 基本形式
```md
[COMMAND_NAME param=value param=value]
```
	•	すべてのコマンドは [] で囲む
	•	パラメータは key=value 形式
	•	パラメータ順は意味を持たない

⸻

### 3.2 SAY

キャラクターまたはナレーションの発話。
```md
[SAY speaker=Ayumi]
こんにちは。[c]
```
パラメータ
	•	speaker（任意）
	•	省略時はナレーション扱い

インライン制御
	•	[c] : クリック待ち

⸻

### 3.3 WAIT

一定時間待機する。
```md
[WAIT 1.0s]
```
### 3.4 SHOW_IMAGE

画像を表示する。
```md
[SHOW_IMAGE file=bg_street_morning]
```
必須パラメータ
	•	file : 表示する画像識別子

エラー
	•	file が指定されていない場合、パースエラー

⸻

### 3.5 PLAY_MUSIC / PLAY_SE
```md
[PLAY_MUSIC file=intro]
[PLAY_SE file=ui_select]
```
	•	音声再生の指示を行う
	•	実際の再生はアプリケーション層の責務

⸻

## 4. 分岐構造（Choices / Route）

### 4.1 Choices

選択肢を定義するブロック。
```md
:::choices
- 駅へ急ぐ @station
- 旅行者を助ける @help
:::
```
	•	@route_name は分岐先識別子
	•	choices ブロックは 直後の route と対応する

⸻

### 4.2 Route

特定の選択肢が選ばれた場合のみ実行されるブロック。
```md
:::route station
    [SAY speaker=Ayumi]
    困っているみたいだね。[c]
:::
```
	•	route 名は対応する choices に存在している必要がある
	•	存在しない場合はワーニング

⸻

4.3 ネスト
	•	choices / route はネスト可能
	•	内側の choices は、外側 route の中でのみ有効

⸻

## 5. 変数・フラグ

### 5.1 宣言
```md
:::flag
helped_tourist: 旅行者を助けたかどうか
route_ayumi: あゆみルートに入った
:::

:::vars
help_count: 旅行者を助けた人数
:::
```
	•	使用する変数・フラグは 事前宣言必須
	•	宣言されていないものを操作するとワーニング

⸻

### 5.2 操作
```md
[SET helped_tourist=TRUE]
[SET help_count+=1]
```
## 6. 条件分岐（When）

条件を満たす場合のみ実行されるブロック。
```md
:::when helped_tourist=TRUE
[SAY speaker=Ayumi]
いいことをしたから、気分がいいな。[c]
:::
```
	•	条件は宣言済み変数・フラグのみ使用可能
	•	未定義条件はワーニング

⸻

## 7. 実行モデル
	•	シナリオは上から順に評価される
	•	choices に到達すると ユーザー入力待ち
	•	route / when は条件を満たした場合のみ評価される
	•	ファイル末尾まで到達すると Halt

⸻

## 8. ドライラン（Dry Run）

ドライランは、実行せずに以下を検査する。
	•	文法エラー
	•	必須パラメータ欠如
	•	未宣言変数・フラグ
	•	到達不能ルート
	•	未対応 route

ドライランは tsumugai の重要なユースケースである。

⸻

## 9. 非対応事項（意図的に行わないこと）
	•	描画・UI・音声再生の実装
	•	複雑な式評価言語
	•	スクリプト埋め込み
	•	エンジン依存の演出仕様

⸻

## 10. 変更方針

本仕様は 実装よりも先に変更される。

仕様が変更された場合、
	•	実装は仕様に追従する
	•	仕様が曖昧な場合は、本書を更新する

## 11. デバッグ実行（Debug Run）

デバッグ実行は、シナリオを実際に実行しながら、
その進行・状態・分岐を人間が観察するための実行モードである。

### 目的

- シナリオ進行の理解
- 分岐条件・変数変化の確認
- 到達順序の把握

### 特徴

- UI・描画は行わない
- 実行単位ごとに情報を表示する
- choices ではユーザー入力を要求する
- when / route の評価結果を明示する

### 非目的

- ゲーム体験の提供
- 演出再現